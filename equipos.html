<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipos Pokémon</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-icons.min.css">
    <script src="js/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            min-height: 100vh;
            min-width: 100vw;
            background: url('a.gif') center center/cover no-repeat fixed;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .team-container {
            background: rgba(0,0,0,0.95);
            border-radius: 2rem;
            box-shadow: 0 0 32px #000a;
            padding: 2rem 2.5rem;
            width: 600px;
            max-width: 98vw;
            color: #fff;
            text-align: left;
        }
        .team-title {
            text-align: center;
            font-weight: bold;
            color: #7fffd4;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }
        .add-btn {
            background: #222;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.5rem;
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        .add-btn:hover {
            background: #444;
        }
        .team-list {
            margin-top: 1.5rem;
        }
        .team-item {
            background: #181818;
            border-radius: 1rem;
            margin-bottom: 1.2rem;
            padding: 1rem 1.2rem;
            cursor: pointer;
            transition: box-shadow 0.2s;
            box-shadow: 0 2px 8px #0004;
        }
        .team-item:hover {
            box-shadow: 0 4px 16px #0008;
        }
        .poke-row {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0.5rem;
        }
        .poke-img {
            width: 50px;
            height: 50px;
            object-fit: scale-down;
            background: #222;
            border-radius: 1rem;
            padding: 2px;
        }
        .poke-types {
            display: flex;
            gap: 0.3rem;
        }
        .poke-type {
            background: #333;
            border-radius: 0.5rem;
            padding: 0.1rem 0.6rem;
            font-size: 0.9em;
            color: #fff;
            border: 1px solid #7fffd4;
        }
        .poke-alfa {
            color: #ffb347;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .team-actions button {
            margin-left: 0.3rem;
        }
        .swal2-select {
            background: #111 !important;
            color: #fff !important;
            border: 1px solid #7fffd4;
            font-weight: bold;
            transition: color 0.2s;
        }
    </style>
</head>
<body>
    <div class="team-container">
        <div class="team-title">Equipos Pokémon <i class="bi bi-people"></i>
            <button class="add-btn" id="addTeamBtn" title="Agregar Equipo"><i class="bi bi-plus"></i></button>
        </div>
        <div id="teamList" class="team-list"></div>
    </div>
    <script>
    // Tipos y tabla de relaciones
    const tipos = [
        "Normal","Fuego","Agua","Planta","Eléctrico","Hielo","Lucha","Veneno","Tierra","Volador","Psíquico","Bicho","Roca","Fantasma","Dragón","Siniestro","Acero","Hada"
    ];
    const tablaTipos = {
        "Fuego": { debil: ["Agua","Roca","Tierra"], fuerte: ["Planta","Bicho","Hielo","Acero"], resiste: ["Fuego","Planta","Hielo","Bicho","Acero","Hada"] },
        "Agua": { debil: ["Eléctrico","Planta"], fuerte: ["Fuego","Roca","Tierra"], resiste: ["Fuego","Agua","Hielo","Acero"] },
        "Planta": { debil: ["Fuego","Bicho","Volador","Hielo","Veneno"], fuerte: ["Agua","Roca","Tierra"], resiste: ["Agua","Planta","Eléctrico","Tierra"] },
        "Eléctrico": { debil: ["Tierra"], fuerte: ["Agua","Volador"], resiste: ["Eléctrico","Acero","Volador"] },
        "Roca": { debil: ["Agua","Planta","Lucha","Tierra","Acero"], fuerte: ["Fuego","Hielo","Bicho","Volador"], resiste: ["Fuego","Normal","Veneno","Volador"] },
        "Tierra": { debil: ["Agua","Planta","Hielo"], fuerte: ["Fuego","Roca","Eléctrico","Veneno","Acero"], resiste: ["Roca","Veneno"], inmune: ["Eléctrico"] },
        "Volador": { debil: ["Eléctrico","Roca","Hielo"], fuerte: ["Planta","Bicho","Lucha"], resiste: ["Planta","Bicho","Lucha"], inmune: ["Tierra"] },
        "Bicho": { debil: ["Fuego","Volador","Roca"], fuerte: ["Planta","Psíquico","Siniestro"], resiste: ["Planta","Lucha","Tierra"] },
        "Hielo": { debil: ["Fuego","Lucha","Roca","Acero"], fuerte: ["Planta","Tierra","Volador","Dragón"], resiste: ["Hielo"] },
        "Lucha": { debil: ["Volador","Psíquico","Hada"], fuerte: ["Normal","Roca","Acero","Hielo","Siniestro"], resiste: ["Bicho","Roca","Siniestro"] },
        "Veneno": { debil: ["Tierra","Psíquico"], fuerte: ["Planta","Hada"], resiste: ["Planta","Lucha","Veneno","Bicho","Hada"] },
        "Psíquico": { debil: ["Bicho","Fantasma","Siniestro"], fuerte: ["Lucha","Veneno"], resiste: ["Psíquico","Lucha"] },
        "Fantasma": { debil: ["Fantasma","Siniestro"], fuerte: ["Psíquico","Fantasma"], resiste: ["Veneno","Bicho"], inmune: ["Normal","Lucha"] },
        "Dragón": { debil: ["Hielo","Dragón","Hada"], fuerte: ["Dragón"], resiste: ["Fuego","Agua","Planta","Eléctrico"] },
        "Siniestro": { debil: ["Lucha","Bicho","Hada"], fuerte: ["Psíquico","Fantasma"], resiste: ["Fantasma","Siniestro"], inmune: ["Psíquico"] },
        "Acero": { debil: ["Fuego","Lucha","Tierra"], fuerte: ["Hielo","Roca","Hada"], resiste: ["Normal","Planta","Hielo","Volador","Psíquico","Bicho","Roca","Dragón","Acero","Hada"], inmune: ["Veneno"] },
        "Hada": { debil: ["Acero","Veneno"], fuerte: ["Lucha","Dragón","Siniestro"], resiste: ["Lucha","Bicho","Siniestro"], inmune: ["Dragón"] },
        "Normal": { debil: ["Lucha"], fuerte: [], resiste: [], inmune: ["Fantasma"] }
    };

    // CRUD de equipos
    function getEquipos() {
        return JSON.parse(localStorage.getItem('equipos') || '[]');
    }
    function saveEquipos(equipos) {
        localStorage.setItem('equipos', JSON.stringify(equipos));
    }
    function renderEquipos() {
        const equipos = getEquipos();
        const pokesBase = getPokemonesBase();
        
        // Sincronizar datos de equipos con CRUD base
        equipos.forEach(equipo => {
            equipo.pokes.forEach(poke => {
                if (poke.numero) {
                    const pokeBase = pokesBase.find(p => p.numero == poke.numero);
                    if (pokeBase) {
                        poke.nombre = pokeBase.nombre;
                        poke.imagen = pokeBase.imagen;
                        poke.tipos = pokeBase.tipos;
                    }
                }
            });
        });
        
        const teamList = document.getElementById('teamList');
        teamList.innerHTML = '';
        equipos.forEach((equipo, idx) => {
            const div = document.createElement('div');
            div.className = 'team-item';
            div.innerHTML = `
                <div style='display:flex;justify-content:space-between;align-items:center;'>
                    <b>Equipo #${idx+1}</b>
                    <span class='team-actions'>
                        <button class='btn btn-sm btn-outline-warning' onclick='editEquipo(${idx});event.stopPropagation();'><i class='bi bi-pencil'></i></button>
                        <button class='btn btn-sm btn-outline-danger' onclick='delEquipo(${idx});event.stopPropagation();'><i class='bi bi-trash'></i></button>
                    </span>
                </div>
                <div>
                    ${equipo.pokes.map(poke => `
                        <div class='poke-row'>
                            <img src='${poke.imagen}' class='poke-img'>
                            <span><b>#${poke.numero}</b></span>
                            <span>${poke.nombre}</span>
                            <span>Nivel: ${poke.nivel}</span>
                            <span>Objeto: ${poke.objeto}</span>
                            <span class='poke-types'>${poke.tipos.map(t=>`<span class='poke-type'>${t}</span>`).join('')}</span>
                            ${poke.alfa ? `<span class='poke-alfa'>Alfa</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            div.onclick = () => mostrarCoberturaEquipo(equipo);
            teamList.appendChild(div);
        });
    }
    function delEquipo(idx) {
        const equipos = getEquipos();
        Swal.fire({
            title: '¿Eliminar equipo?',
            text: 'Esta acción no se puede deshacer.',
            background: '#181818',
            color: '#fff',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#222'
        }).then((result) => {
            if (result.isConfirmed) {
                equipos.splice(idx, 1);
                saveEquipos(equipos);
                renderEquipos();
            }
        });
    }
    function editEquipo(idx) {
        agregarEditarEquipo(idx);
    }
    document.getElementById('addTeamBtn').onclick = () => agregarEditarEquipo();

    function getPokemonesBase() {
        return JSON.parse(localStorage.getItem('pokemonesBase') || '[]');
    }

    function sincronizarConBase(numero, nombre, imagen) {
        const pokesBase = JSON.parse(localStorage.getItem('pokemonesBase') || '[]');
        const pokeBase = pokesBase.find(p => p.numero == numero);
        if (pokeBase) {
            pokeBase.nombre = nombre;
            pokeBase.imagen = imagen;
            localStorage.setItem('pokemonesBase', JSON.stringify(pokesBase));
        }
    }

    function agregarEditarEquipo(idx) {
        const equipos = getEquipos();
        let equipo = idx !== undefined ? equipos[idx] : { pokes: [] };
        let pokes = equipo.pokes.length ? equipo.pokes : Array(7).fill(null).map(()=>({imagen:'',numero:'',nivel:'',nombre:'',objeto:'',alfa:false,tipos:[]}));
        let html = `<div style='max-height:60vh;overflow-y:auto;'>`;
        for(let i=0;i<7;i++) {
            html += `
                <div style='border-bottom:1px solid #444;margin-bottom:0.7rem;padding-bottom:0.7rem;'>
                    <h5>Pokémon ${i+1}</h5>
                    <button type='button' class='btn btn-info btn-sm' style='margin-bottom:0.5rem' onclick='mostrarPickerPokemon(${i})'>Seleccionar de base</button><br>
                    <div id='picker-container-${i}' style='display:none;background:#111;border-radius:0.5rem;padding:0.5rem;margin-bottom:0.5rem;'>
                        <input type='text' id='search-picker-${i}' class='swal2-input' placeholder='Buscar por nombre o número...' style='margin-bottom:0.5rem;'>
                        <div id='picker-list-${i}' style='max-height:150px;overflow-y:auto;'></div>
                    </div>
                    <input type='file' accept='image/*' id='poke-img-${i}' class='swal2-file'><br>
                    <img id='poke-preview-${i}' src='${pokes[i].imagen||''}' style='width:40px;${pokes[i].imagen?'display:inline-block':'display:none'};margin:0.3rem 0;'>
                    <input id='poke-numero-${i}' class='swal2-input' placeholder='N° Pokédex' type='number' value='${pokes[i].numero||''}'>
                    <input id='poke-nombre-${i}' class='swal2-input' placeholder='Nombre' value='${pokes[i].nombre||''}'>
                    <input id='poke-nivel-${i}' class='swal2-input' placeholder='Nivel' type='number' value='${pokes[i].nivel||''}'>
                    <input id='poke-objeto-${i}' class='swal2-input' placeholder='Objeto equipado' value='${pokes[i].objeto||''}'>
                    <label style='color:#fff;font-size:0.95em;'><input type='checkbox' id='poke-alfa-${i}' ${pokes[i].alfa?'checked':''}> Alfa</label><br>
                    <label style='color:#fff;font-size:0.95em;'>Tipo 1:</label>
                    <select id='poke-tipo1-${i}' class='swal2-select'><option value=''>---</option>${tipos.map(t=>`<option value='${t}' ${pokes[i].tipos[0]===t?'selected':''}>${t}</option>`).join('')}</select>
                    <label style='color:#fff;font-size:0.95em;'>Tipo 2:</label>
                    <select id='poke-tipo2-${i}' class='swal2-select'><option value=''>---</option>${tipos.map(t=>`<option value='${t}' ${pokes[i].tipos[1]===t?'selected':''}>${t}</option>`).join('')}</select>
                </div>`;
        }
        html += `</div>`;
        Swal.fire({
            title: idx!==undefined?'Editar equipo':'Agregar equipo',
            html,
            background: '#181818',
            color: '#fff',
            width: 700,
            confirmButtonText: idx!==undefined?'Guardar':'Agregar',
            showCancelButton: true,
            cancelButtonText: 'Cancelar',
            didOpen: () => {
                for(let i=0;i<7;i++) {
                    document.getElementById(`poke-img-${i}`).addEventListener('change', function(e) {
                        if (e.target.files && e.target.files[0]) {
                            const reader = new FileReader();
                            reader.onload = () => {
                                document.getElementById(`poke-preview-${i}`).src = reader.result;
                                document.getElementById(`poke-preview-${i}`).style.display = 'inline-block';
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        }
                    });
                    // Colorear selects según tipo
                    const sel1 = document.getElementById(`poke-tipo1-${i}`);
                    const sel2 = document.getElementById(`poke-tipo2-${i}`);
                    setSelectColor(sel1);
                    setSelectColor(sel2);
                    sel1.addEventListener('change', function(){ setSelectColor(sel1); });
                    sel2.addEventListener('change', function(){ setSelectColor(sel2); });
                }
            },
            preConfirm: () => {
                let pokes = [];
                for(let i=0;i<7;i++) {
                    let imagen = document.getElementById(`poke-preview-${i}`).src || '';
                    if(imagen && imagen.startsWith('file://')) imagen = '';
                    let numero = document.getElementById(`poke-numero-${i}`).value;
                    let nombre = document.getElementById(`poke-nombre-${i}`).value;
                    let nivel = document.getElementById(`poke-nivel-${i}`).value;
                    let objeto = document.getElementById(`poke-objeto-${i}`).value;
                    let alfa = document.getElementById(`poke-alfa-${i}`).checked;
                    let tipo1 = document.getElementById(`poke-tipo1-${i}`).value;
                    let tipo2 = document.getElementById(`poke-tipo2-${i}`).value;
                    if(numero || nombre || imagen) {
                        let tiposPoke = [];
                        if(tipo1) tiposPoke.push(tipo1);
                        if(tipo2 && tipo2!==tipo1) tiposPoke.push(tipo2);
                        pokes.push({imagen,numero,nombre,nivel,objeto,alfa,tipos:tiposPoke});
                        
                        // Sincronizar con CRUD base si hay cambios
                        if(numero && nombre && imagen) {
                            sincronizarConBase(numero, nombre, imagen);
                        }
                    }
                }
                if(pokes.length===0) {
                    Swal.showValidationMessage('Agrega al menos un Pokémon al equipo');
                    return false;
                }
                return {pokes};
            }
        }).then(res => {
            if(res.isConfirmed) {
                if(idx!==undefined) equipos[idx] = res.value;
                else equipos.push(res.value);
                saveEquipos(equipos);
                renderEquipos();
            }
        });
    }

    // Mostrar picker de pokemon base
    function mostrarPickerPokemon(slot) {
        const pokesBase = getPokemonesBase();
        const container = document.getElementById(`picker-container-${slot}`);
        const list = document.getElementById(`picker-list-${slot}`);
        const search = document.getElementById(`search-picker-${slot}`);
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            renderPickerList(slot, pokesBase);
            
            search.oninput = function() {
                const val = this.value.toLowerCase();
                const filtered = pokesBase.filter(p => 
                    p.nombre.toLowerCase().includes(val) || 
                    (p.numero+'').includes(val)
                );
                renderPickerList(slot, filtered);
            };
        } else {
            container.style.display = 'none';
        }
    }
    
    function renderPickerList(slot, pokes) {
        const list = document.getElementById(`picker-list-${slot}`);
        list.innerHTML = pokes.map((poke, i) => `
            <div style='display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem;cursor:pointer;padding:0.3rem;border-radius:0.3rem;background:#222;' onclick='seleccionarPokeDelPicker(${slot},${i})'>
                <img src='${poke.imagen}' style='width:32px;height:32px;object-fit:scale-down;background:#333;border-radius:0.5rem;'>
                <span><b>#${poke.numero}</b></span>
                <span>${poke.nombre}</span>
                <span class='poke-types'>${poke.tipos.map(t=>`<span class='poke-type' style='color:${tipoColor(t)}'>${t}</span>`).join('')}</span>
            </div>
        `).join('');
    }
    
    function seleccionarPokeDelPicker(slot, baseIdx) {
        const pokesBase = getPokemonesBase();
        const poke = pokesBase[baseIdx];
        const preview = document.getElementById(`poke-preview-${slot}`);
        const numero = document.getElementById(`poke-numero-${slot}`);
        const nombre = document.getElementById(`poke-nombre-${slot}`);
        const tipo1 = document.getElementById(`poke-tipo1-${slot}`);
        const tipo2 = document.getElementById(`poke-tipo2-${slot}`);
        
        if (preview) {
            preview.src = poke.imagen;
            preview.style.display = 'inline-block';
        }
        if (numero) numero.value = poke.numero;
        if (nombre) nombre.value = poke.nombre;
        if (tipo1) {
            tipo1.value = poke.tipos[0]||'';
            setSelectColor(tipo1);
        }
        if (tipo2) {
            tipo2.value = poke.tipos[1]||'';
            setSelectColor(tipo2);
        }
        
        // Ocultar el picker
        document.getElementById(`picker-container-${slot}`).style.display = 'none';
    }

    function mostrarCoberturaEquipo(equipo) {
        // Calcular frecuencia de tipos, coberturas y debilidades
        let freq = {};
        let cobertura = new Set();
        let debilidad = new Set();
        equipo.pokes.forEach(poke => {
            poke.tipos.forEach(tipo => {
                freq[tipo] = (freq[tipo]||0)+1;
                if(tablaTipos[tipo]) {
                    (tablaTipos[tipo].fuerte||[]).forEach(t=>cobertura.add(t));
                    (tablaTipos[tipo].debil||[]).forEach(t=>debilidad.add(t));
                }
            });
        });
        // Quitar coberturas que también sean debilidades
        let coberturaArr = Array.from(cobertura).filter(t=>!debilidad.has(t));
        let debilidadArr = Array.from(debilidad);
        // Gráfica de frecuencia de tipos
        Swal.fire({
            title: 'Cobertura y debilidades',
            html: `<canvas id='teamChart' width='220' height='220'></canvas><br>
                   <b>Tipos en el equipo:</b> ${Object.keys(freq).length ? Object.entries(freq).map(([t,c])=>`${t} (${c})`).join(', ') : 'Ninguno'}<br>
                   <b>Cobertura fuerte contra:</b> ${coberturaArr.length ? coberturaArr.join(', ') : 'Ninguno'}<br>
                   <b>Debilidades:</b> ${debilidadArr.length ? debilidadArr.join(', ') : 'Ninguna'}`,
            background: '#181818',
            color: '#fff',
            width: 500,
            didOpen: () => {
                const ctx = document.getElementById('teamChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(freq),
                        datasets: [{
                            data: Object.values(freq),
                            backgroundColor: Object.keys(freq).map(t=>tipoColor(t)),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        plugins: {
                            legend: {display: true, labels: {color:'#fff'}},
                            tooltip: {enabled: true}
                        }
                    }
                });
            }
        });
    }
    function tipoColor(tipo) {
        // Colores aproximados por tipo
        const colores = {
            Normal: '#A8A77A', Fuego: '#EE8130', Agua: '#6390F0', Planta: '#7AC74C', Eléctrico: '#F7D02C',
            Hielo: '#96D9D6', Lucha: '#C22E28', Veneno: '#A33EA1', Tierra: '#E2BF65', Volador: '#A98FF3',
            Psíquico: '#F95587', Bicho: '#A6B91A', Roca: '#B6A136', Fantasma: '#735797', Dragón: '#6F35FC',
            Siniestro: '#705746', Acero: '#B7B7CE', Hada: '#D685AD'
        };
        return colores[tipo]||'#fff';
    }
    function setSelectColor(select) {
        const colores = {
            Normal: '#A8A77A', Fuego: '#EE8130', Agua: '#6390F0', Planta: '#7AC74C', Eléctrico: '#F7D02C',
            Hielo: '#96D9D6', Lucha: '#C22E28', Veneno: '#A33EA1', Tierra: '#E2BF65', Volador: '#A98FF3',
            Psíquico: '#F95587', Bicho: '#A6B91A', Roca: '#B6A136', Fantasma: '#735797', Dragón: '#6F35FC',
            Siniestro: '#705746', Acero: '#B7B7CE', Hada: '#D685AD'
        };
        const tipo = select.value;
        select.style.color = colores[tipo] || '#fff';
    }
    // Inicializar
    renderEquipos();
    </script>
</body>
</html>
